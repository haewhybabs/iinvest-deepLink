<!DOCTYPE html>
<html>
    <head>
    <title>iOS Automatic Deep Linking</title>
    </head>
    <body>
        <script>
            (function() {
                const iOS = !!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform);
                var storeUrl=iOS?'https://apps.apple.com/ng/app/i-invest/id1381126486':'https://play.google.com/store/apps/details?id=com.cousant.naijainvest';
                
                var my_app_name = "i-invest";
                var my_app_id = "id1438151717"
                var my_app_scheme = "iinvest://"

                function toggleModal(isModal, inputs, elems, msg) {
                    for (const input of inputs) input.disabled = isModal;
                    modal.style.display = isModal ? "block" : "none";
                    elems[0].textContent = isModal ? msg : "";
                }

                function myConfirm(msg) {
                const inputs = [...document.querySelectorAll("input, textarea, select")].filter(input => !input.disabled);
                const modal = document.getElementById("modal");
                const elems = modal.children[0].children;

                return new Promise((resolve) => {
                    toggleModal(true, inputs, elems, msg);
                    elems[3].onclick = () => resolve(true);
                    elems[4].onclick = () => resolve(false);
                }).then(result => {
                    toggleModal(false, inputs, elems, msg);
                    return result;
                });
                }

                function redirectMessage() {
                var r = myConfirm("To download " + my_app_name + ", tap OK.");
                return r.then(ok => {
                    if (ok) {
                    console.log("Redirecting to the App Store...");
                    window.location = storeUrl
                    } else {
                    console.log("User cancelled redirect to the App Store");
                    }
                    return ok;
                });
                }

                    function prepareListener() {
                        document.addEventListener("visibilitychange", function() {
                            const inputs = [...document.querySelectorAll("input, textarea, select")].filter(input => !input.disabled);
                            const modal = document.getElementById("modal");
                            const elems = modal.children[0].children;

                            if (!document.hasFocus()) {
                            console.log("User left tab. Closing modal popup")
                            toggleModal(false, inputs, elems, "");
                            }
                        });
                    }

                    function onTap() {
                        setTimeout(function() {
                            // We can't avoid the "invalid address" Safari popup,
                            // but at least we can explain it to users.
                            // We will create a modal popup behind it, which the
                            // event listener will close automatically if the app 
                            // opens and we leave the tab

                            redirectMessage()

                        }, 50);
                        window.location = my_app_scheme;
                    }
                    prepareListener()
                })();
        </script>
    </body>

</html>
